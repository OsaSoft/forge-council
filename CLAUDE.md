# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

> `CLAUDE.md` and `AGENTS.md` are autogenerated by `/Init`. Do not edit directly -- run `/Update` to regenerate.

## What This Is

forge-council is a pure-markdown multi-agent orchestration framework. Thirteen specialist agents run structured 3-round debates (Initial Positions, Challenges, Convergence) organized into four council types plus standalone use. No compiled code -- only markdown agent definitions, YAML configuration, and shell scripts.

## Install / Verify

```bash
make install          # deploy agents + skills (Claude, Gemini, Codex)
make verify           # check agents deployed + skills present
make verify-skills    # verify skills across all runtimes
make clean            # remove previously installed agents
make lint             # shellcheck all scripts
```

Standalone agent deployment without Make:

```bash
bash lib/install-agents.sh agents              # install all agents
bash lib/install-agents.sh agents --dry-run    # preview
bash lib/install-agents.sh agents --clean      # clean + reinstall
```

No automated tests or CI. Verification is manual per `VERIFY.md` plus `make verify`.

## Architecture

```
agents/           13 specialist markdown files (frontmatter + structured body)
skills/           5 skill dirs: Council, DeveloperCouncil, ProductCouncil, KnowledgeCouncil, Demo
lib/              git submodule -> forge-lib (shell utilities for deployment)
defaults.yaml     canonical agent roster + council compositions
config.yaml       user overrides (gitignored), same structure as defaults
module.yaml       module metadata (name, version)
.claude-plugin/   plugin.json manifest for Claude Code plugin discovery
```

### How Councils Work

Skills define the orchestration. The main session IS the moderator (never spawn a separate moderator). Flow: gate check (agent teams flag) -> parse input -> select roster (max 7) -> spawn team (TeamCreate + parallel Task) -> 3 rounds -> synthesize verdict + teardown (TeamDelete). If agent teams are unavailable, falls back to sequential subagent calls.

Parallel council execution requires `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` in `~/.claude/settings.json` env, or `teams: enabled` in `config.yaml`. Without either, same debate runs sequentially.

### Agent Files (`agents/*.md`)

YAML frontmatter with required keys: `title`, `description`, `claude.name` (PascalCase, matches filename), `claude.model` (sonnet/opus), `claude.description` (pattern: `"Role -- capabilities. USE WHEN triggers."`), `claude.tools`.

Body structure in order: blockquote summary (ends with "Shipped with forge-council."), `## Role`, `## Expertise`, `## Personality` (optional), `## Instructions`, `## Output Format`, `## Constraints`.

Constraints must include the honesty clause ("If X is solid, say so") and team communication clause ("communicate findings to the team lead via SendMessage when done"). Every critique must include a concrete suggestion.

### Tool Assignments

| Tools | Agents |
|-------|--------|
| Read, Grep, Glob | Architect, Designer, DocumentationWriter, Opponent |
| Read, Grep, Glob, Bash | Database, DevOps, SecurityArchitect, ForensicAgent |
| Read, Grep, Glob, Bash, Write, Edit | Developer, Tester |
| Read, Grep, Glob, WebSearch, WebFetch | Researcher, ProductManager, Analyst |

All agents use `sonnet` except Opponent which uses `opus`. Model selection lives in agent frontmatter, not in YAML config.

### Skill Files (`skills/*/SKILL.md` + `SKILL.yaml`)

`SKILL.md` contains orchestration instructions. `SKILL.yaml` contains metadata and provider routing (`claude`, `gemini`, `codex`). Skills follow numbered steps (Step 1-8). Debate modes detected from user keywords: checkpoint (default), autonomous ("fast"), interactive ("step by step"), quick ("quick check").

### Configuration

- `defaults.yaml`: canonical roster -- edit only when adding/removing agents
- `config.yaml`: user overrides (gitignored) -- same structure, only changed fields
- `module.yaml`: module metadata -- update `version` on releases

### forge-lib Submodule (`lib/`)

Git submodule from `forge-lib`. Provides: `frontmatter.sh` (fm_value, fm_body), `install-agents.sh` (deploy_agent, deploy_agents_from_dir), `install-skills.sh` (provider-aware installer), `generate-agent-skills.sh` (Codex specialist wrapper generation), `strip-front.sh`. If missing: `git submodule update --init`.

## Conventions

### Naming

| Context | Convention |
|---------|-----------|
| Agent filenames / claude.name | PascalCase (`SecurityArchitect.md`) |
| Skill directories | PascalCase (`DeveloperCouncil/`) |
| Shell functions | lowercase_snake_case |
| Shell constants | UPPER_SNAKE_CASE |
| YAML keys | lowercase |
| Team names (runtime) | lowercase-kebab (`dev-council`) |

### Shell Scripts

Shebang `#!/usr/bin/env bash`, start with `set -euo pipefail`. Resolve paths with `SCRIPT_DIR="$(builtin cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`. Source libraries, don't execute. Functions use `local` variables and don't exit (let caller decide). Prefer `FORGE_LIB` env var from forge-core, fall back to local `lib/`.

### Markdown Style

Em-dashes (`--`) in prose. `claude.description` uses pattern: `"Role -- capabilities. USE WHEN triggers."`. No trailing whitespace. Files end with newline.

### Git

Conventional Commits: `type: description`. Lowercase, no trailing period, no scope. Types: `feat`, `fix`, `docs`.

## Modification Workflows

**Add agent**: Create `agents/Name.md` with frontmatter + structured body -> add to `defaults.yaml` roster -> `bash lib/install-agents.sh agents --dry-run` -> commit `feat: add Name for [domain]`.

**Modify skill**: Edit `skills/Name/SKILL.md` + `SKILL.yaml` -> keep step numbering intact -> if changing roster, update both skill and `defaults.yaml` -> test with `/Demo`.

**Update model/tools**: Edit agent frontmatter -> `bash lib/install-agents.sh agents --clean` -> restart session.
